name: Sync Artifact from Another Repo to Release

on:
  # 手动触发，方便测试和按需运行
  workflow_dispatch:
    inputs:
      target_repo:
        description: 'ArKT-7/woawin'
        required: true
        default: 'ArKT-7/woawin'
      workflow_name:
        description: 'ltsc-uup-iso.yml'
        required: true
        default: 'ltsc-uup-iso.yml'
      artifact_name:
        description: 'ESD_LTSC_IOT_ENTERPRISE_26100.7840.260206-0415.GE_RELEASE_SVC_PROD1_CLIENT_A64FRE_EN-US'
        required: true
        default: 'ESD_LTSC_IOT_ENTERPRISE_26100.7840.260206-0415.GE_RELEASE_SVC_PROD1_CLIENT_A64FRE_EN-US'
      run_id:
        description: '21935596871'
        required: true
        default: '21935596871'

permissions:
  contents: write   # 允许当前工作流创建/更新 Release

jobs:
  download-and-upload:
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.PAT }}   # 设置全局环境变量，供所有 gh 命令使用
    steps:
      # 如果没有提供 run_id，则获取指定工作流的最新成功运行 ID
      - name: Get latest successful run ID
        id: get_run
        if: github.event.inputs.run_id == ''
        env:
          REPO: ${{ github.event.inputs.target_repo }}
          WORKFLOW: ${{ github.event.inputs.workflow_name }}
          BRANCH: ${{ github.event.inputs.branch }}
        run: |
          # 构建分支参数（如果提供了分支）
          BRANCH_ARG=""
          if [ -n "$BRANCH" ]; then
            BRANCH_ARG="--branch $BRANCH"
          fi
          # 使用 gh run list 获取最新成功运行的 ID
          RUN_ID=$(gh run list --repo "$REPO" --workflow "$WORKFLOW" $BRANCH_ARG --status success --limit 1 --json databaseId --jq '.[0].databaseId')
          if [ -z "$RUN_ID" ]; then
            echo "No successful run found for the given criteria."
            exit 1
          fi
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT
          echo "Found latest run ID: $RUN_ID"

      # 下载 Artifact（使用 run_id）
      - name: Download Artifact using gh
        env:
          REPO: ${{ github.event.inputs.target_repo }}
          ARTIFACT_NAME: ${{ github.event.inputs.artifact_name }}
          # 如果提供了 run_id，直接使用；否则使用上一步获取的 ID
          RUN_ID: ${{ github.event.inputs.run_id || steps.get_run.outputs.run_id }}
        run: |
          echo "Downloading artifact '$ARTIFACT_NAME' from run $RUN_ID in repo $REPO"
          # 创建下载目录
          mkdir -p ./downloaded_artifact
          # gh run download 会自动解压 artifact 到指定目录
          gh run download "$RUN_ID" --repo "$REPO" --name "$ARTIFACT_NAME" --dir ./downloaded_artifact

      # 列出下载的文件（可选）
      - name: List downloaded files
        run: ls -la ./downloaded_artifact/

      # 分割大于2GB的文件（GitHub Release 限制为 2GB）
      - name: Split large files (>2GB)
        run: |
          # 查找所有大于2GB的文件（使用字节比较：2GB = 2147483648）
          large_files=$(find ./downloaded_artifact -type f -size +2147483647c)
          if [ -n "$large_files" ]; then
            echo "Found large files exceeding 2GB limit. Splitting them into 1.9GB chunks to be safe."
            for file in $large_files; do
              echo "Splitting $file"
              # 获取文件名和目录
              dir=$(dirname "$file")
              base=$(basename "$file")
              # 使用 split 分割，每个文件最大 1900M（留点余量，避免接近极限）
              split -b 1900M "$file" "$dir/${base}." -d --additional-suffix=.part
              # 删除原文件
              rm -f "$file"
            done
          else
            echo "No files exceed 2GB limit."
          fi

      - name: List files after split
        run: ls -la ./downloaded_artifact/

      # 上传到当前仓库的 Release
      - name: Upload to Release
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          tag: "synced-artifact"
          artifacts: "./downloaded_artifact/*"
          token: ${{ secrets.GITHUB_TOKEN }}
